<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tidy POS - Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg-dark: #1e222d; --bg-card: #2d3343; --accent: #ff6b00; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; }
        .tab-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .card-mesa { border-radius: 12px; transition: 0.3s; }
        .status-libre { background-color: #bbf7d0; color: #166534; }
        .status-preparacion { background-color: #fef08a; color: #854d0e; } /* Amarillo */
        .status-listo { background-color: #10b981; color: white; animation: pulse 1s infinite; } /* Verde Parpadeo */
        .status-espera { background-color: #2d3343; border: 1px solid #ff6b00; color: white; } /* Por Cobrar */
        .status-limpiar { background-color: #3b82f6; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header class="p-5 pb-0">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-black text-white">TIDY</h1>
            <div class="bg-orange-500/10 text-orange-500 px-3 py-1 rounded-full text-[10px] font-bold">
                TASA: <span id="display-tasa">0.00</span> Bs
            </div>
        </div>

        <nav class="flex gap-6 mb-4 border-b border-gray-700">
            <button onclick="showTab('mesas')" class="tab-btn active pb-2 text-sm font-bold">Dashboard</button>
            <button onclick="showTab('config')" class="tab-btn pb-2 text-sm font-bold">Configuración</button>
        </nav>

        <div class="bg-[#2d3343] p-1 rounded-xl flex gap-1 mb-6">
            <button onclick="filterType('mesas')" class="f-btn flex-1 py-2 text-xs font-bold rounded-lg bg-gray-700">Mesas</button>
            <button onclick="filterType('cocina')" class="f-btn flex-1 py-2 text-xs font-bold rounded-lg">Cocina</button>
            <button onclick="filterType('caja')" class="f-btn flex-1 py-2 text-xs font-bold rounded-lg">Caja</button>
        </div>
    </header>

    <main class="px-5 pb-24">
        <section id="sec-mesas" class="content-sec">
            <div id="grid-mesas" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </section>

        <section id="sec-cocina" class="content-sec hidden">
            <div id="lista-cocina" class="space-y-4"></div>
        </section>

        <section id="sec-caja" class="content-sec hidden text-center">
            <div id="lista-caja" class="space-y-3"></div>
        </section>

        <section id="sec-config" class="content-sec hidden">
            <div class="bg-card p-6 rounded-3xl space-y-4">
                <label class="text-xs font-bold opacity-50 uppercase">Tasa de Cambio (Bs)</label>
                <input type="number" id="input-tasa" onchange="updateTasa(this.value)" class="w-full bg-[#1e222d] p-4 rounded-xl outline-none border border-gray-700">
                
                <h3 class="text-xs font-bold text-orange-500 uppercase mt-6">Gestión de Platillos</h3>
                <input type="text" id="new-n" placeholder="Nombre" class="w-full bg-[#1e222d] p-3 rounded-xl border border-gray-700">
                <input type="number" id="new-p" placeholder="Precio $" class="w-full bg-[#1e222d] p-3 rounded-xl border border-gray-700">
                <button onclick="addPlatillo()" class="w-full bg-orange-500 py-3 rounded-xl font-bold">Agregar</button>
                <div id="crud-list" class="space-y-2 mt-4"></div>
            </div>
        </section>
    </main>

    <div id="modal-pos" class="fixed inset-0 bg-black/95 hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-card w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl border border-white/5">
            <h2 class="text-2xl font-black mb-1">Caja POS</h2>
            <p class="text-xs opacity-50 mb-6">Mesa <span id="pos-mesa-id"></span></p>
            
            <div class="bg-black/20 p-4 rounded-2xl mb-6 flex justify-between">
                <div><p class="text-[10px] opacity-50 uppercase">Total USD</p><p class="text-xl font-black text-orange-500">$<span id="pos-total-usd">0</span></p></div>
                <div class="text-right"><p class="text-[10px] opacity-50 uppercase">Total Bs</p><p class="text-xl font-black text-green-500"><span id="pos-total-bs">0</span></p></div>
            </div>

            <div class="space-y-3 mb-8">
                <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl border border-white/10">
                    <i class="fas fa-money-bill text-green-500"></i>
                    <input type="number" id="m-efectivo" oninput="calcPOS()" placeholder="Efectivo $" class="bg-transparent w-full outline-none text-sm">
                </div>
                <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl border border-white/10">
                    <i class="fas fa-credit-card text-blue-400"></i>
                    <input type="number" id="m-debito" oninput="calcPOS()" placeholder="Tarjeta / Débito $" class="bg-transparent w-full outline-none text-sm">
                </div>
                <div class="flex items-center gap-2 bg-white/5 p-3 rounded-xl border border-white/10">
                    <i class="fas fa-exchange-alt text-purple-400"></i>
                    <input type="number" id="m-trans" oninput="calcPOS()" placeholder="Transferencia Bs" class="bg-transparent w-full outline-none text-sm">
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold uppercase opacity-50">Faltante:</span>
                <span id="pos-restante" class="text-lg font-bold text-red-500">$0.00</span>
            </div>

            <button onclick="finalizarVenta()" id="btn-finalizar" class="w-full bg-green-500 text-black py-4 rounded-2xl font-black uppercase shadow-lg shadow-green-500/20 opacity-50 pointer-events-none">Finalizar Cobro</button>
            <button onclick="closePOS()" class="w-full mt-3 text-[10px] uppercase opacity-30">Cancelar</button>
        </div>
    </div>

    <div id="modal-orden" class="fixed inset-0 bg-black/90 hidden z-50 flex items-end">
        <div class="bg-card w-full rounded-t-[2.5rem] p-8 max-h-[90vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h2 id="orden-titulo" class="text-2xl font-black">Mesa</h2>
                <button onclick="closeOrden()" class="text-2xl">&times;</button>
            </div>
            <div id="orden-items-list" class="space-y-3 mb-6"></div>
            <div id="orden-btns" class="space-y-3"></div>
        </div>
    </div>

    <script>
        let state = {
            tasa: 37.5,
            mesas: Array.from({length: 12}, (_, i) => ({ id: i + 1, status: 'libre', items: [], total: 0 })),
            menu: [
                { id: 1, nombre: 'Pizza', precio: 8.5 },
                { id: 2, nombre: 'Refresco', precio: 2 }
            ],
            cocina: [],
            mesaActiva: null
        };

        function showTab(tab) {
            document.querySelectorAll('.content-sec').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + tab).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function filterType(type) {
            document.querySelectorAll('.content-sec').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-' + type).classList.remove('hidden');
            document.querySelectorAll('.f-btn').forEach(b => b.classList.remove('bg-gray-700'));
            event.target.classList.add('bg-gray-700');
            render();
        }

        function addPlatillo() {
            const n = document.getElementById('new-n').value;
            const p = parseFloat(document.getElementById('new-p').value);
            if(n && p) {
                state.menu.push({ id: Date.now(), nombre: n, precio: p });
                render();
            }
        }

        function deletePlatillo(id) {
            state.menu = state.menu.filter(m => m.id !== id);
            render();
        }

        function updateTasa(v) { state.tasa = parseFloat(v); render(); }

        // --- FLUJO ---
        function openMesa(id) {
            state.mesaActiva = id;
            const mesa = state.mesas.find(m => m.id === id);
            
            if(mesa.status === 'limpiar') {
                if(confirm("¿Mesa lista para nuevos clientes?")) {
                    mesa.status = 'libre'; mesa.items = []; mesa.total = 0; render();
                }
                return;
            }

            const list = document.getElementById('orden-items-list');
            list.innerHTML = mesa.items.map(i => `<div class="flex justify-between bg-white/5 p-4 rounded-xl"><span>${i.nombre}</span><span class="font-bold">$${i.precio}</span></div>`).join('') || '<p class="opacity-30 text-center">Mesa vacía</p>';

            const btns = document.getElementById('orden-btns');
            if(mesa.status === 'listo') {
                btns.innerHTML = `<button onclick="marcarEntregado(${id})" class="w-full bg-green-500 text-black py-4 rounded-2xl font-black">ENTREGAR PEDIDO</button>`;
            } else {
                btns.innerHTML = `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        ${state.menu.map(p => `<button onclick="addMesaItem(${p.id})" class="bg-white/10 p-3 rounded-xl text-[10px] font-bold uppercase">${p.nombre}</button>`).join('')}
                    </div>
                    <button onclick="enviarCocina(${id})" class="w-full bg-orange-500 py-4 rounded-2xl font-black">ENVIAR A COCINA</button>
                `;
            }
            document.getElementById('modal-orden').classList.remove('hidden');
        }

        function addMesaItem(pid) {
            const p = state.menu.find(x => x.id === pid);
            const mesa = state.mesas.find(m => m.id === state.mesaActiva);
            mesa.items.push(p);
            mesa.total += p.precio;
            openMesa(state.mesaActiva);
        }

        function enviarCocina(id) {
            const mesa = state.mesas.find(m => m.id === id);
            if(mesa.items.length > 0) {
                mesa.status = 'preparacion';
                state.cocina.push({ id: Date.now(), mesaId: id, platos: [...mesa.items] });
                closeOrden();
                render();
            }
        }

        function marcarEntregado(id) {
            const mesa = state.mesas.find(m => m.id === id);
            mesa.status = 'espera'; // Ahora aparece en Caja
            closeOrden();
            render();
        }

        function terminarCocina(oid) {
            const o = state.cocina.find(x => x.id === oid);
            const mesa = state.mesas.find(m => m.id === o.mesaId);
            mesa.status = 'listo'; // Parpadeo verde para mesero
            state.cocina = state.cocina.filter(x => x.id !== oid);
            render();
        }

        // --- POS ---
        function openPOS(id) {
            state.mesaActiva = id;
            const mesa = state.mesas.find(m => m.id === id);
            document.getElementById('pos-mesa-id').innerText = id;
            document.getElementById('pos-total-usd').innerText = mesa.total.toFixed(2);
            document.getElementById('pos-total-bs').innerText = (mesa.total * state.tasa).toFixed(2);
            
            document.getElementById('m-efectivo').value = '';
            document.getElementById('m-debito').value = '';
            document.getElementById('m-trans').value = '';
            calcPOS();
            document.getElementById('modal-pos').classList.remove('hidden');
        }

        function calcPOS() {
            const total = state.mesas.find(m => m.id === state.mesaActiva).total;
            const ef = parseFloat(document.getElementById('m-efectivo').value) || 0;
            const de = parseFloat(document.getElementById('m-debito').value) || 0;
            const tr = (parseFloat(document.getElementById('m-trans').value) || 0) / state.tasa;
            
            const pagado = ef + de + tr;
            const resta = total - pagado;
            
            const resDisplay = document.getElementById('pos-restante');
            resDisplay.innerText = resta <= 0.01 ? "SALDADO" : `$${resta.toFixed(2)}`;
            resDisplay.className = resta <= 0.01 ? "text-lg font-bold text-green-500" : "text-lg font-bold text-red-500";
            
            const btn = document.getElementById('btn-finalizar');
            btn.className = resta <= 0.01 ? "w-full bg-green-500 text-black py-4 rounded-2xl font-black uppercase shadow-lg shadow-green-500/20" : "w-full bg-gray-600 text-black py-4 rounded-2xl font-black uppercase opacity-50 pointer-events-none";
        }

        function finalizarVenta() {
            const mesa = state.mesas.find(m => m.id === state.mesaActiva);
            mesa.status = 'limpiar';
            document.getElementById('modal-pos').classList.add('hidden');
            render();
        }

        // --- RENDERS ---
        function render() {
            document.getElementById('display-tasa').innerText = state.tasa.toFixed(2);
            document.getElementById('input-tasa').value = state.tasa;

            const grid = document.getElementById('grid-mesas');
            grid.innerHTML = state.mesas.map(m => `
                <div onclick="openMesa(${m.id})" class="card-mesa aspect-square flex flex-col items-center justify-center p-4 status-${m.status}">
                    <span class="text-[10px] font-bold opacity-60 uppercase">Mesa ${m.id}</span>
                    <span class="text-4xl font-black">${m.id}</span>
                    <span class="text-[9px] font-bold mt-2 tracking-widest uppercase">${m.status}</span>
                </div>
            `).join('');

            const kList = document.getElementById('lista-cocina');
            kList.innerHTML = state.cocina.map(o => `
                <div class="bg-card p-6 rounded-[2rem] border border-white/5">
                    <p class="font-black text-xl mb-4 text-orange-500">Mesa ${o.mesaId}</p>
                    <div class="text-sm opacity-70 mb-6">${o.platos.map(p => `• ${p.nombre}`).join('<br>')}</div>
                    <button onclick="terminarCocina(${o.id})" class="w-full bg-white text-black py-3 rounded-xl font-bold uppercase text-[10px]">MARCAR LISTO</button>
                </div>
            `).join('') || '<p class="opacity-20 text-center py-10">Cocina vacía</p>';

            const cList = document.getElementById('lista-caja');
            const pends = state.mesas.filter(m => m.status === 'espera');
            cList.innerHTML = pends.map(m => `
                <div class="bg-card p-6 rounded-[2.5rem] flex justify-between items-center">
                    <div class="text-left">
                        <p class="text-[10px] opacity-40 uppercase font-bold">Mesa ${m.id}</p>
                        <p class="text-2xl font-black">$${m.total.toFixed(2)}</p>
                    </div>
                    <button onclick="openPOS(${m.id})" class="bg-white text-black px-8 py-3 rounded-2xl font-black text-xs">COBRAR</button>
                </div>
            `).join('') || '<div class="opacity-20 py-20 font-bold">SIN CUENTAS POR COBRAR</div>';

            const crud = document.getElementById('crud-list');
            crud.innerHTML = state.menu.map(p => `
                <div class="flex justify-between bg-black/20 p-4 rounded-xl items-center">
                    <span class="text-sm">${p.nombre} ($${p.precio})</span>
                    <button onclick="deletePlatillo(${p.id})" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function closeOrden() { document.getElementById('modal-orden').classList.add('hidden'); }
        function closePOS() { document.getElementById('modal-pos').classList.add('hidden'); }

        render();
    </script>
</body>
</html>
