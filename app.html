<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tidy - Flujo Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --accent: #ff6b00; --bg-dark: #121212; --bg-card: #1e1e1e; }
        body { background-color: var(--bg-dark); color: #e0e0e0; font-family: sans-serif; }
        .bg-card { background-color: var(--bg-card); }
        .accent-bg { background-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ALERTAS DE MESA */
        .status-ready { animation: pulse-green 1.5s infinite; background-color: #059669 !important; color: white; }
        .status-cleaning { background-color: #3b82f6 !important; color: white; animation: pulse-blue 2s infinite; }
        
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes pulse-blue { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="no-scrollbar">

    <header class="p-6 sticky top-0 bg-[#121212] z-40 border-b border-white/10">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-black tracking-tighter text-white">TIDY</h1>
            <div id="notif-badge" class="hidden bg-green-500 text-[10px] font-bold px-2 py-1 rounded-full animate-bounce text-black">PEDIDO LISTO</div>
        </div>
        <nav class="flex bg-white/5 p-1 rounded-2xl gap-1">
            <button onclick="showTab('mesas')" class="nav-link flex-1 py-3 rounded-xl text-xs font-bold transition-all">MESAS</button>
            <button onclick="showTab('cocina')" class="nav-link flex-1 py-3 rounded-xl text-xs font-bold transition-all">COCINA</button>
            <button onclick="showTab('caja')" class="nav-link flex-1 py-3 rounded-xl text-xs font-bold transition-all">CAJA</button>
            <button onclick="showTab('config')" class="nav-link flex-1 py-3 rounded-xl text-xs font-bold transition-all">CONFIG</button>
        </nav>
    </header>

    <main class="p-6 pb-32">
        <section id="mesas" class="tab-content active">
            <div id="grid-mesas" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </section>

        <section id="cocina" class="tab-content">
            <div id="lista-cocina" class="grid gap-4"></div>
        </section>

        <section id="caja" class="tab-content">
            <div id="lista-caja" class="space-y-4"></div>
        </section>

        <section id="config" class="tab-content">
            <div class="bg-card p-6 rounded-3xl mb-4">
                <h3 class="text-xs font-bold text-orange-500 uppercase mb-4">Tasa del Día</h3>
                <input type="number" id="cfg-tasa" onchange="app.tasa = this.value; render();" class="w-full bg-black/40 p-4 rounded-xl outline-none">
            </div>
            <div class="bg-card p-6 rounded-3xl">
                <h3 class="text-xs font-bold text-orange-500 uppercase mb-4">Menú (CRUD)</h3>
                <input type="text" id="p-nombre" placeholder="Nombre" class="w-full bg-black/40 p-3 rounded-xl mb-2 outline-none">
                <input type="number" id="p-precio" placeholder="Precio $" class="w-full bg-black/40 p-3 rounded-xl mb-4 outline-none">
                <button onclick="savePlatillo()" class="w-full accent-bg py-3 rounded-xl font-bold mb-4">Añadir al Menú</button>
                <div id="lista-menu-crud" class="space-y-2"></div>
            </div>
        </section>
    </main>

    <div id="modal-pago" class="fixed inset-0 bg-black/95 hidden z-50 flex items-center justify-center p-6">
        <div class="bg-card w-full max-w-md rounded-[2.5rem] p-8">
            <h2 class="text-2xl font-black mb-2">Cobrar Mesa <span id="pago-mesa-id"></span></h2>
            <div class="flex justify-between text-orange-500 font-bold mb-6">
                <span>Total: $<span id="pago-total-usd"></span></span>
                <span>Bs <span id="pago-total-bs"></span></span>
            </div>
            
            <div class="space-y-4 mb-8">
                <div>
                    <label class="text-[10px] opacity-50 uppercase">Monto en Dólares ($)</label>
                    <input type="number" id="input-pay-usd" oninput="calcularRestante()" class="w-full bg-black/40 p-4 rounded-2xl outline-none border border-white/10 focus:border-green-500 text-xl font-bold">
                </div>
                <div>
                    <label class="text-[10px] opacity-50 uppercase">Restante en Bolívares (Bs)</label>
                    <div id="output-pay-bs" class="w-full bg-white/5 p-4 rounded-2xl text-xl font-bold text-green-400">0.00</div>
                </div>
            </div>
            
            <button onclick="confirmarPago()" class="w-full bg-green-500 text-black py-5 rounded-2xl font-black uppercase tracking-widest">Finalizar Transacción</button>
            <button onclick="closeModalPago()" class="w-full py-4 text-xs opacity-50 uppercase mt-2">Cancelar</button>
        </div>
    </div>

    <div id="modal-pedido" class="fixed inset-0 bg-black/90 hidden z-50 flex items-end">
        <div class="bg-card w-full rounded-t-[2.5rem] p-8 max-h-[85vh] flex flex-col">
            <h2 id="mesa-titulo" class="text-3xl font-black mb-6">Mesa</h2>
            <div id="items-mesa" class="flex-1 overflow-y-auto space-y-3 mb-6"></div>
            <div id="acciones-mesa" class="space-y-3"></div>
            <button onclick="closeModalPedido()" class="w-full py-4 text-xs opacity-50 uppercase">Volver</button>
        </div>
    </div>

    <script>
        let app = {
            tasa: 36.5,
            mesas: Array.from({length: 9}, (_, i) => ({ 
                id: i + 1, 
                status: 'libre', // libre, ocupada, listo, limpieza
                items: [] 
            })),
            menu: [
                { id: 1, nombre: 'Pizza Margarita', precio: 12 },
                { id: 2, nombre: 'Burger Tidy', precio: 10 }
            ],
            ordenesCocina: [],
            mesaActiva: null
        };

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            render();
        }

        function savePlatillo() {
            const n = document.getElementById('p-nombre').value;
            const p = parseFloat(document.getElementById('p-precio').value);
            if(n && p) {
                app.menu.push({ id: Date.now(), nombre: n, precio: p });
                render();
            }
        }

        // --- FLUJO DE MESA ---
        function openMesa(id) {
            app.mesaActiva = id;
            const mesa = app.mesas.find(m => m.id === id);
            
            if(mesa.status === 'limpieza') {
                if(confirm("¿Mesa limpia y lista para nuevos clientes?")) {
                    mesa.status = 'libre';
                    mesa.items = [];
                    render();
                }
                return;
            }

            document.getElementById('mesa-titulo').innerText = `Mesa ${id}`;
            renderDetalleMesa();
            document.getElementById('modal-pedido').classList.remove('hidden');
        }

        function renderDetalleMesa() {
            const mesa = app.mesas.find(m => m.id === app.mesaActiva);
            const container = document.getElementById('items-mesa');
            const acciones = document.getElementById('acciones-mesa');

            container.innerHTML = mesa.items.map(i => `
                <div class="flex justify-between bg-white/5 p-4 rounded-xl">
                    <span>${i.nombre}</span>
                    <span class="font-bold">$${i.precio}</span>
                </div>
            `).join('') || '<p class="opacity-30 text-center italic">Sin productos</p>';

            if(mesa.status === 'listo') {
                acciones.innerHTML = `<button onclick="entregarPedido(${mesa.id})" class="w-full bg-green-500 text-black py-4 rounded-xl font-black uppercase">Marcar como Entregado</button>`;
            } else {
                acciones.innerHTML = `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        ${app.menu.map(p => `<button onclick="addItem(${p.id})" class="bg-white/10 p-3 rounded-lg text-[10px] uppercase font-bold">${p.nombre}</button>`).join('')}
                    </div>
                    <button onclick="enviarACocina(${mesa.id})" class="w-full bg-orange-500 py-4 rounded-xl font-black uppercase">Enviar a Cocina</button>
                `;
            }
        }

        function addItem(pid) {
            const p = app.menu.find(x => x.id === pid);
            const mesa = app.mesas.find(m => m.id === app.mesaActiva);
            mesa.items.push(p);
            mesa.status = 'ocupada';
            renderDetalleMesa();
        }

        function enviarACocina(id) {
            const mesa = app.mesas.find(m => m.id === id);
            app.ordenesCocina.push({ id: Date.now(), mesaId: id, platos: [...mesa.items] });
            closeModalPedido();
            render();
        }

        function entregarPedido(id) {
            const mesa = app.mesas.find(m => m.id === id);
            mesa.status = 'ocupada'; // Vuelve a ocupada pero ya sin alerta de "listo"
            closeModalPedido();
            render();
        }

        // --- COCINA ---
        function terminarPlato(oid) {
            const orden = app.ordenesCocina.find(o => o.id === oid);
            const mesa = app.mesas.find(m => m.id === orden.mesaId);
            mesa.status = 'listo'; // Aquí se activa el parpadeo verde para el mesero
            app.ordenesCocina = app.ordenesCocina.filter(o => o.id !== oid);
            render();
        }

        // --- CAJA Y PAGO MIXTO ---
        function abrirPago(id) {
            app.mesaActiva = id;
            const mesa = app.mesas.find(m => m.id === id);
            const total = mesa.items.reduce((a,b) => a + b.precio, 0);
            
            document.getElementById('pago-mesa-id').innerText = id;
            document.getElementById('pago-total-usd').innerText = total.toFixed(2);
            document.getElementById('pago-total-bs').innerText = (total * app.tasa).toFixed(2);
            document.getElementById('input-pay-usd').value = total;
            calcularRestante();
            document.getElementById('modal-pago').classList.remove('hidden');
        }

        function calcularRestante() {
            const total = app.mesas.find(m => m.id === app.mesaActiva).items.reduce((a,b) => a+b.precio, 0);
            const pagoUSD = parseFloat(document.getElementById('input-pay-usd').value) || 0;
            const restanteUSD = total - pagoUSD;
            const restanteBS = restanteUSD * app.tasa;
            
            document.getElementById('output-pay-bs').innerText = (restanteBS > 0 ? restanteBS : 0).toFixed(2);
        }

        function confirmarPago() {
            const mesa = app.mesas.find(m => m.id === app.mesaActiva);
            mesa.status = 'limpieza'; // Pasa a limpieza después de cobrar
            document.getElementById('modal-pago').classList.add('hidden');
            render();
        }

        // --- RENDERS ---
        function render() {
            // Mesas
            const grid = document.getElementById('grid-mesas');
            grid.innerHTML = app.mesas.map(m => {
                let statusClass = '';
                let label = m.status.toUpperCase();
                if(m.status === 'listo') statusClass = 'status-ready';
                if(m.status === 'limpieza') { statusClass = 'status-cleaning'; label = 'LIMPIAR'; }
                if(m.status === 'libre') statusClass = 'bg-green-500/10 border border-green-500/50 text-green-500';
                if(m.status === 'ocupada') statusClass = 'bg-white/5 border border-white/10';

                return `
                    <div onclick="openMesa(${m.id})" class="aspect-square rounded-[2rem] flex flex-col items-center justify-center p-4 transition-all active:scale-95 ${statusClass}">
                        <span class="text-[10px] font-bold opacity-50">MESA</span>
                        <span class="text-4xl font-black">${m.id}</span>
                        <span class="text-[9px] font-bold mt-2 tracking-widest">${label}</span>
                    </div>
                `;
            }).join('');

            // Cocina
            const kList = document.getElementById('lista-cocina');
            kList.innerHTML = app.ordenesCocina.map(o => `
                <div class="bg-card p-6 rounded-3xl border border-white/5">
                    <div class="flex justify-between mb-4">
                        <span class="text-xl font-bold">Mesa ${o.mesaId}</span>
                        <span class="text-xs accent-bg px-2 py-1 rounded">NUEVO</span>
                    </div>
                    <div class="text-sm opacity-70 mb-6">${o.platos.map(p => `• ${p.nombre}`).join('<br>')}</div>
                    <button onclick="terminarPlato(${o.id})" class="w-full bg-white text-black py-3 rounded-xl font-bold uppercase text-xs">Terminar Orden</button>
                </div>
            `).join('');

            // Caja
            const cList = document.getElementById('lista-caja');
            const ocupadas = app.mesas.filter(m => m.status === 'ocupada' || m.status === 'listo');
            cList.innerHTML = ocupadas.map(m => {
                const total = m.items.reduce((a,b)=>a+b.precio, 0);
                return `
                    <div class="bg-card p-6 rounded-3xl flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-bold opacity-40 uppercase">Mesa ${m.id}</p>
                            <p class="text-xl font-black">$${total.toFixed(2)}</p>
                        </div>
                        <button onclick="abrirPago(${m.id})" class="bg-white text-black px-6 py-3 rounded-xl font-bold text-xs">COBRAR</button>
                    </div>
                `;
            }).join('');

            // CRUD Menu
            document.getElementById('lista-menu-crud').innerHTML = app.menu.map(p => `
                <div class="flex justify-between bg-black/20 p-3 rounded-xl text-sm">
                    <span>${p.nombre} ($${p.precio})</span>
                    <button onclick="app.menu = app.menu.filter(x=>x.id!==${p.id}); render();" class="text-red-500"><i class="fas fa-times"></i></button>
                </div>
            `).join('');

            // Badge de notificación global
            const hayListo = app.mesas.some(m => m.status === 'listo');
            document.getElementById('notif-badge').style.display = hayListo ? 'block' : 'none';
        }

        function closeModalPedido() { document.getElementById('modal-pedido').classList.add('hidden'); }
        function closeModalPago() { document.getElementById('modal-pago').classList.add('hidden'); }

        render();
    </script>
</body>
</html>
